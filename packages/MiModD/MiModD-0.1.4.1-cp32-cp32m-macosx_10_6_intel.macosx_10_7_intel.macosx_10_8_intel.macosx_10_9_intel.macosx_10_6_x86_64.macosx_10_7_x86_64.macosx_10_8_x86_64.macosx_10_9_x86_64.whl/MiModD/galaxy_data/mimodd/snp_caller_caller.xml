<tool id="snp_caller_caller" name="Variant Calling and Coverage Analysis">
  <description>Predict SNPs and indels in one or more aligned read samples and calculate the coverage of every base in the reference genome using samtools/bcftools</description>
  <command> 
	mimodd varcall

	$ref_genome
	#for $l in $list_input
            ${l.inputfile}
        #end for
	--output_vcf=$output_vcf
        #if $cov:
	--output_cov=$output_cov
	#end if
	#if $cstats:
	--cstats=$output_stats
	#end if
        --depth=$depth
	#if $sites.use_sites:
        --sites=$sites.sitelist
        --output_sites=$output_sites
	#end if
	$group_by_id
        --verbose
        --quiet
  </command>

  <inputs>
    <param name="ref_genome" type="data" format="fasta" label="reference genome" />
    <repeat name="list_input" title="Aligned reads input source" default="1" min="1">
      <param name="inputfile" type="data" format="bam" label="input file" />
    </repeat>
    <param name="group_by_id" type="boolean" label="group reads based on read group id only" truevalue="-i" falsevalue="" checked="true" help="If selected, this option ensures that only the read group id (but not the sample name) is considered in grouping reads in the input file(s). If turned off, read groups with identical sample names are automatically pooled and analyzed together even if they come from different NGS runs." />

    <param name = "cov" type = "boolean" checked = "true" label = "produce coverage file" />
    <param name = "cstats" type = "boolean" checked = "true" label = "generate coverage statistics" />

      <conditional name="sites">
      <param name="use_sites" type="boolean" checked = "false" label="report on sites specified by positions" help = "Select if you want the optional position-specified sites vcf file to be generated (see the tool help below)." />

      ## default settings   
      <when value="false">
	<param name="sites" type="hidden" value="None"/>
      </when>
      
      ## change settings
      <when value="true">
	<param name="sitelist" type="data" format="vcf" label="list of genomic positions indicating sites to report on independent of genotypes" help="Select a vcf file that lists the genomic positions you wish to have reported on in the position-specified sites file."/>
      </when>

    </conditional>
    <param name="depth" type="integer" value="250" label="maximum per-BAM depth (default: 250)" help="to avoid excessive use of memory"/>
  </inputs>

  <outputs>
    <data name="output_vcf" format="vcf" label="Variant Calls from MiModd samtools Variant Calling on ${on_string}"/>
    <data name="output_cov" format="tabular" label="MiModD Coverage Analysis on ${on_string}">
        <filter>cov</filter>
    </data>
    <data name="output_stats" format="tabular" label="MiModD Coverage Statistics ${on_string}">
        <filter>cstats</filter>
    </data>

    <data name="output_sites" format="vcf" label="Fixed-sites Nucleotide Calls from MiModd samtools Variant Calling on ${on_string}">
        <filter>sites['use_sites']</filter>
    </data>
  </outputs>

<help>
.. class:: infomark

   **What it does**

The tool calls variants (SNPs and indels) with respect to the reference genome from the aligned reads in the input files. 

It produces up to three output files:

1) The *variant sites file* is in vcf format and includes one line for every genomic position at which a variant is found.

   When the input files hold aligned reads from more than one sample, a variant detected in one sample is enough for inclusion.
   The sample-specific information in the last columns of the output file will provide detailed information about the genotype likelihoods for each sample.

2) The optional *coverage file* reports the depth of coverage for each sample per base across the entire reference genome.

   This file is required by the *Deletion Prediction* tool.

3) The optional *position-specified sites file* is in vcf format again. If *report on sites specified by positions* was selected, it will have one line per user-defined genomic position independent of whether that position is included also in the variant sites vcf file or not.

   **TIP:** This file is what you will need for the **Cloudmap** *Hawaiian Variant Mapping* tool.

**Note:**

The tool uses samtools mpileup and bcftools for variant calling, but exposes just a single configuration parameter of these tools - the *maximum per-BAM depth*. Through this parameter, the maximum number of reads considered for variant calling at any site can be controlled. Its default value of 250 is taken from *samtools mpileup* and usually suitable. Consider, however, that this gives the maximum read number per input file, so if you have a large number of samples in one input file, it could become necessary to increase the value to get sufficient reads considered per sample.

</help>
</tool>
