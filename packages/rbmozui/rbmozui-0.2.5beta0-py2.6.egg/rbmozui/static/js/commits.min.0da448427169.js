(function(){$(document).ready(function(){var epochKey="p2rb.reviewer_epoch";var rootEditor=RB.PageManager.getPage().reviewRequestEditor;var rootEditorView=RB.PageManager.getPage().reviewRequestEditorView;var rootRequest=rootEditor.get("reviewRequest");var warning=$("#review-request-warning");var isEditable=rootEditor.get("mutableByUser");var rootThingToLoad=isEditable?rootRequest.draft:rootRequest;var requestOrDraft=function(reviewRequest){return reviewRequest.draft.id!==undefined?reviewRequest.draft:reviewRequest};var getReviewers=function(reviewable){return reviewable.get("targetPeople").map(function(aItem){return aItem["username"]||aItem["title"]}).join(", ")};rootThingToLoad.ready({ready:function(){var epoch=parseInt(rootRequest.get("extraData")[epochKey],10)||0;console.log("Loaded epoch: "+epoch);var isSquashed=rootRequest.get("extraData")["p2rb.is_squashed"]=="True";console.log("This request is squashed?: "+isSquashed);var updateSquashedReviewers=function(){var reviewerNames=[];$(".child-rr-reviewers").each(function(i,reviewerList){reviewerNames=reviewerNames.concat($(reviewerList).text().split(", "))});reviewerNames=_.unique(reviewerNames).join(",");console.log("Setting root reviewer names to: "+reviewerNames);rootEditor.setDraftField("targetPeople",reviewerNames,{jsonFieldName:"target_people",success:function(){console.log("Successfully set reviewers on root review request.");epoch++;console.log("Setting epoch to: "+epoch);rootEditor.setDraftField(epochKey,epoch,{fieldID:epochKey,useExtraData:true,success:function(){console.log("Reviewers and epoch correctly set.")},error:function(aErrorObject){console.error("Failed to bump epoch on squashed review request: "+aErrorObject.errorText)}})},error:function(aErrorObject){console.error("Failed to set reviewers on squashed review: "+aErrorObject.errorText)}})};$(".child-rr-reviewers").each(function(i,reviewerList){console.log("Constructing reviewer list for item at index "+i);var rid=$(reviewerList).data("id");console.log("Fetching info for review request with id: "+rid);var rr=new RB.ReviewRequest({id:rid});var thingToLoad=isEditable?rr.draft:rr;thingToLoad.ready({ready:function(){var thingToReview=requestOrDraft(rr);var reviewers=getReviewers(thingToReview);console.log("Got reviewers: "+reviewers);$(reviewerList).text(reviewers);var editorOptions={editIconClass:"rb-icon rb-icon-edit",useEditIconOnly:true,enabled:isEditable&&isSquashed};$(reviewerList).inlineEditor(editorOptions).on({beginEdit:function(){console.assert(isEditable,"User needs edit permissions on this review request.");rootEditor.incr("editCount")},cancel:_.bind(function(){rootEditor.decr("editCount")},this),complete:_.bind(function(e,value){console.assert(isEditable,"User needs edit permissions on this review request.");var editor=new RB.ReviewRequestEditor({reviewRequest:rr});editor.setDraftField("targetPeople",value,{jsonFieldName:"target_people",error:function(error){rootEditor.decr("editCount");console.error(error);warning.delay(6e3).fadeOut(400,function(){$(this).hide()}).show().html(error.errorText);$(reviewerList).text(reviewers)},success:function(){rootEditor.decr("editCount");updateSquashedReviewers();rootEditorView.showBanner();$(reviewerList).text(getReviewers(rr.draft))}},this)},this)});var acOptions={fieldName:"users",nameKey:"username",descKey:"fullname",extraParams:{fullname:1},cmp:function(term,a,b){var aUsername=a.data.username,bUsername=b.data.username,aFullname=a.data.fullname||"",bFullname=a.data.fullname||"";if(aUsername.indexOf(term)===0){if(bUsername.indexOf(term)===0){return aUsername.localeCompare(bUsername)}return-1}else if(bUsername.indexOf(term)===0){return 1}else{return aFullname.localeCompare(bFullname)}}};$(reviewerList).inlineEditor("field").rbautocomplete({formatItem:function(data){var s=data[acOptions.nameKey];if(acOptions.descKey&&data[acOptions.descKey]){s+=" <span>("+_.escape(data[acOptions.descKey])+")</span>"}return s},matchCase:false,multiple:true,parse:function(data){var items=data[acOptions.fieldName],itemsLen=items.length,parsed=[],value,i;for(i=0;i<itemsLen;i++){value=items[i];parsed.push({data:value,value:value[acOptions.nameKey],result:value[acOptions.nameKey]})}return parsed},url:SITE_ROOT+"api/"+(acOptions.resourceName||acOptions.fieldName)+"/",extraParams:acOptions.extraParams,cmp:acOptions.cmp,width:350,error:function(xhr){var text;try{text=$.parseJSON(xhr.responseText).err.msg}catch(e){text="HTTP "+xhr.status+" "+xhr.statusText}reportError(text)}}).on("autocompleteshow",function(){var resultsPane=$(".ui-autocomplete-results:not("+":has(.ui-autocomplete-footer))");if(resultsPane.length>0){$("<div/>").addClass("ui-autocomplete-footer").text(gettext("Press Tab to auto-complete.")).appendTo(resultsPane)}})}})})},error:function(error){console.error(error)}})})}).call(this);