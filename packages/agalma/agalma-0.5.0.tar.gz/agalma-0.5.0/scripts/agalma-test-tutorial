#!/bin/bash

set -e

LEVEL=${1-"1"}

if [ $LEVEL -lt 3 ]; then
	echo "$0: skipping"
	exit 0
fi

DIR=`mktemp -d $PWD/agalma-test-tutorial-XXX`

echo "Created temp directory '$DIR'"
cd $DIR

if [ -n "$BIOLITE_RESOURCES" ]
then
	SAVE_BIOLITE_RESOURCES=",$BIOLITE_RESOURCES"
fi
export BIOLITE_RESOURCES="database=$DIR/biolite.sqlite,agalma_database=$DIR/agalma.sqlite,outdir=$DIR$SAVE_BIOLITE_RESOURCES"

mkdir -p agalma/analyses
mkdir -p agalma/data
mkdir -p agalma/scratch
export BIOLITE_RESOURCES="database=$PWD/agalma/biolite.sqlite"
cd agalma/data
agalma testdata
agalma catalog insert --paths SRX288285_1.fq SRX288285_2.fq --species "Agalma elegans" --ncbi_id 316166 --itis_id 51383
export BIOLITE_RESOURCES="$BIOLITE_RESOURCES,threads=2,memory=4G"
cd ../scratch
agalma transcriptome --id HWI-ST625-73-C0JUVACXX-7 --outdir ../analyses
cd ..
agalma report --id HWI-ST625-73-C0JUVACXX-7 --outdir reports/HWI-ST625-73-C0JUVACXX-7
agalma resources --id HWI-ST625-73-C0JUVACXX-7 --outdir reports/HWI-ST625-73-C0JUVACXX-7
export BIOLITE_RESOURCES="$BIOLITE_RESOURCES,outdir=$PWD/analyses,agalma_database=$PWD/agalma.sqlite"
cd data
agalma catalog insert --id SRX288285 --paths SRX288285_1.fq SRX288285_2.fq --species "Agalma elegans" --ncbi_id 316166
agalma catalog insert --id SRX288432 --paths SRX288432_1.fq SRX288432_2.fq --species "Craseoa lathetica" --ncbi_id 316205
agalma catalog insert --id SRX288431 --paths SRX288431_1.fq SRX288431_2.fq --species "Physalia physalis" --ncbi_id 168775
agalma catalog insert --id SRX288430 --paths SRX288430_1.fq SRX288430_2.fq --species "Nanomia bijuga" --ncbi_id 168759
agalma catalog insert --id JGI_NEMVEC --paths JGI_NEMVEC.fa --species "Nematostella vectensis" --ncbi_id 45351
cd ../scratch
agalma postassemble --id SRX288285 --assembly ../data/SRX288285.fa
agalma postassemble --id SRX288430 --assembly ../data/SRX288430.fa
agalma postassemble --id SRX288431 --assembly ../data/SRX288431.fa
agalma postassemble --id SRX288432 --assembly ../data/SRX288432.fa
agalma postassemble --id JGI_NEMVEC --external
agalma load --id SRX288285
agalma load --id SRX288430
agalma load --id SRX288431
agalma load --id SRX288432
agalma load --id JGI_NEMVEC
export LOAD_IDS=$(agalma diagnostics runid -n load)
agalma homologize --id PhylogenyTest $LOAD_IDS
agalma multalign --id PhylogenyTest
agalma genetree --id PhylogenyTest
agalma treeprune --id PhylogenyTest
agalma multalign --id PhylogenyTest
agalma supermatrix --id PhylogenyTest
agalma speciestree --id PhylogenyTest --raxml_flags="-o Nematostella_vectensis"
cd ..
agalma report --id PhylogenyTest --outdir reports/PhylogenyTest
agalma resources --id PhylogenyTest --outdir reports/PhylogenyTest
agalma phylogeny_report --id PhylogenyTest --outdir reports/PhylogenyTest
agalma diagnostics list
