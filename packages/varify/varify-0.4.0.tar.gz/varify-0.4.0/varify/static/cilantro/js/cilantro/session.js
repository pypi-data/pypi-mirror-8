define(["jquery","underscore","backbone","./models","./utils","./router","./core"],function(e,t,i,n,s,o,r){var a={SESSION_OPENING:"session:opening",SESSION_ERROR:"session:error",SESSION_UNAUTHORIZED:"session:unauthorized",SESSION_OPENED:"session:opened",SESSION_CLOSED:"session:closed"},h={concepts:n.Concepts,fields:n.FieldCollection,contexts:n.ContextCollection,views:n.ViewCollection,preview:n.Results,exporter:n.ExporterCollection,queries:n.Queries,public_queries:n.Queries},u=n.Model.extend({idAttribute:"url",options:function(){return r.config.get("session.defaults")},initialize:function(e,i){this.options=t.extend({},t.result(this,"options"),i),this.opened=!1,this.started=!1,this.opening=!1,this.state={},t.bindAll(this,"ping","startPing","stopPing")},validate:function(e){return e&&e.url?void 0:"url is required"},startPing:function(){this.links.ping&&this.options.ping&&!this._ping&&(this.ping(),this._ping=setInterval(this.ping,this.options.ping))},stopPing:function(){clearTimeout(this._ping),delete this._ping},ping:function(){var e=this;i.ajax({type:"GET",url:this.links.ping,dataType:"json",success:function(t){"timeout"===t.status&&(e.stopPing(),e.timeout(t.location))},error:function(t,i,n){e.stopPing(),"FOUND"===n&&this.timeout(t.getResponseHeader("Location"))}})},timeout:function(e){var t;t=e?'Your session timed out. Please <a href="'+e+'">refresh the page</a>.':"Your session timed out. Please refresh the page.",r.notify({header:"Session Timeout",message:t,dismissable:!1,timeout:!1,level:"warning"}),setTimeout(function(){e?window.location=location:window.location.reload(!0)},5e3)},parse:function(e){e=e||{},this.title=e.title,this.version=e.version,this.data={};var i;t.each(e._links,function(e,t){(i=h[t])&&(this.data[t]=new i,this.data[t].url=e.href,this.data[t].fetch({reset:!0}))},this),this.router=new o.Router({main:r.config.get("main"),root:r.config.get("root")});var n=this.get("routes");if(n)if("string"==typeof n){var s=this;require([n],function(e){s.router.register(e)})}else"function"==typeof n&&(n=n()),this.router.register(n);return e},open:function(){if(this.opened||this.opening)return this._opening.promise();if(!this.isValid())throw new Error(this.validationError);this.opening=!0,this._opening=e.Deferred();var t={url:this.get("url"),type:"GET",dataType:"json"},i=this.get("credentials");i&&e.extend(t,{type:"POST",contentType:"application/json",data:JSON.stringify(i)});var n=this;return this.fetch(t).always(function(){n.opening=!1}).done(function(e,t,i){n.opened=!0,n._opening.resolveWith(n,[n,e,t,i])}).fail(function(e,t,i){n.error=i,n._opening.rejectWith(n,[this,e,t,i])}),this._opening.promise()},close:function(){this.end(),this.opening=this.opened=!1,t.each(this.data,function(e){e.reset(),delete e.url}),delete this._opening,delete this.data},start:function(e,t){if(this.started)return!1;if(!this.opened)throw new Error("Session must be opened before loaded");this.started=!0,e&&this.router.register(e),this.router.start(t),this.startPing(),this.listenTo(r,{visible:this.startPing,hidden:this.stopPing}),r.isSupported(r.getSerranoVersion())||r.notify({header:"Serrano Version Unsupported",level:"warning",timeout:!1,message:"You are connecting to an unsupported version of Serrano. Some functionality may be broken or missing due to compatibility issues."})},end:function(){this.started=!1,this.stopPing(),this.stopListening(r,"visible hidden"),this.router.unregister()}}),d=i.Collection.extend({_switch:function(e){this.active!==e&&(delete this.pending,this.close(),this.active=e,this.trigger(a.SESSION_OPENED,e))},open:function(e,t){"object"==typeof e?t=e:(t=t||{},t.url=e);var i=this.get(t.url);i||(i=new u(t),this.add(i)),i!==this.active&&i!==this.pending&&(this.pending=i,this.trigger(a.SESSION_OPENING,i));var n=this;return i.open().done(function(){n.pending===i&&n._switch(i)}).fail(function(e,t,s,o){if(n.pending===i){n.pending=null;var r;r=401===t.statusCode||403===t.statusCode?a.SESSION_UNAUTHORIZED:a.SESSION_ERROR,n.trigger(r,i,o)}})},close:function(){if(this.active){var e=this.active;delete this.active,this.remove(e),e.close(),this.trigger(a.SESSION_CLOSED,e)}},clear:function(){this.close(),this.reset()}});return t.extend({SessionManager:d,Session:u,events:a})});
//# sourceMappingURL=session.js.map