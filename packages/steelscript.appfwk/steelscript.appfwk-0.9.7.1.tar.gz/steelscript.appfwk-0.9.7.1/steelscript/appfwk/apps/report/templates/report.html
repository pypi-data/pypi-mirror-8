{% extends "base.html" %}
{% block comments %}
<!--
# Copyright (c) 2014 Riverbed Technology, Inc.
#
# This software is licensed under the terms and conditions of the MIT License
# accompanying the software ("License").  This software is distributed "AS IS"
# as set forth in the License.
-->
{% endblock %}

{% load tz %}
{% load url from future %}

{% block header %}
    <link href="{{ STATIC_URL }}css/report.css" rel="stylesheet"/>
    <link href="{{ STATIC_URL }}showLoading/css/showLoading.css" rel="stylesheet"/>
    <script type="text/javascript" src="{{ STATIC_URL }}showLoading/js/jquery.showLoading.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}jquery-timepicker/jquery.timepicker.min.js"></script>

    {% if maps_version == 'DEVELOPER' %}
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
    {% elif maps_version == 'FREE' %}
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3%key={{ maps_api_key }}&sensor=false"></script>
    {% elif maps_version == 'BUSINESS' %}
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3&client={{ maps_api_key }}&sensor=false"></script>
    {% endif %}

    <script type="text/javascript" src="{{ STATIC_URL }}js/rvbd-widgets.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/rvbd-report.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/rvbd-yui3.js"></script>

    {% if maps_version == 'OPEN_STREET_MAPS' %}
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.2/leaflet.js"></script>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.2/leaflet.css" />
        <script type="text/javascript" src="{{ STATIC_URL }}js/rvbd-openstreetmaps.js"></script>
    {% else %}
        <script type="text/javascript" src="{{ STATIC_URL }}js/rvbd-google-maps.js"></script>
    {% endif %}


    <script type="text/javascript">
      var runRequested = false;
      var debugFlag = false;
      $(document).ready( function() {
          $.ajaxSetup({
              beforeSend: function(xhr) {
                  xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
              }
          });
          // rvbd_debug_url is used in report.js to allow the user to download a zip
          // of the debug information if rvbd_debug is set to true.
          rvbd_debug_url = "{% url 'steelscript.appfwk.apps.report.views.download_debug' %}";

          {% if report.hide_criteria %}

          renderPage("{% url 'report-widgets' report.namespace report.slug %}");
          {% if report.reload_minutes > 0 %}setInterval(function() { renderPage("{% url 'report-widgets' report.namespace report.slug %}"); }, {{ report.reload_minutes }} * 60 * 1000);{% endif %}

          {% else %}

          $("#criteria").on('hidden', function() { dorun(); });
          $('form#criteriaform').submit(function() {
              run();
              return false;
          });

          {% endif %}

        });

    </script>

    <style>
        .loading-indicator
        {
            height: 80px;
            width: 80px;
            background: url( '{{ STATIC_URL }}showLoading/images/loading.gif' );
            background-repeat: no-repeat;
            background-position: center center;
        }
    </style>
{% endblock %}

{% block header_row %}<h2>{{ report.title }}</h3>{% endblock %}

{% block content %}
    {% if report.description %}
    <div class="report-description">
      {{ report.description | safe }}
    </div>
    {% endif %}
    {% if not report.hide_criteria %}
    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span12 widget-box">
          <div class="widget-title">
            <a data-toggle="collapse" data-target="#criteria" href="#">
              Criteria
            </a>
          </div>
          <div class="collapse in" id="criteria">
            <div class="widget-content">
                <form class="form-horizontal" action="{% url 'report-view' report.namespace report.slug %}" method="post" id="criteriaform"
                        {% if form.is_multipart %}enctype="multipart/form-data"{% endif %}>
                    {% csrf_token %}
                    <fieldset>
                        <div id="form-error-info" class="text-error"></div>

                        {% if form.errors %}
                            <p class="text-error">Please correct the errors below.</p>
                        {% endif %}

                        {% for s in section_map %}
                            <div class="criteria-group">
                                {% if show_sections %}
                                    <div class="criteria-group-title"> {{ s.title }} </div>
                                {% endif %}
                                <div class="criteria-group-contents">
                                    {% for field in form.visible_fields %}
                                        {% if field.name in s.parameters %}
                                            <div class="control-group">
                                                <div class="control-label">
                                                    {{ field.label_tag }}
                                                </div>
                                                <div class="controls">
                                                    <span id='{{ field.auto_id }}-span'>{{ field }}</span>
                                                    {% if field.errors %}
                                                        {% for err in field.errors %}
                                                            <p class="text-error">{{ err }}</p>
                                                        {% endfor %}
                                                    {% endif %}
                                                    {% if field.help_text %}
                                                        <span class="icon-info-sign" title="{{ field.help_text }}"></span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                        {% for hidden in form.hidden_fields %}
                            {{ hidden }}
                        {% endfor %}
                    </fieldset>
              </form>
              <p></p>
              <div class="btn-group dropup">
                  <button class="btn btn-primary" onclick="run()">Run</button>
                  <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                    <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu">
                      {% if developer %}
                          <li><a href="#" onclick="runDebug()"> Debug This Report </a></li>
                      {% endif %}
                      <li><a href="#" onclick="updateTimeAndRun()"> Update Time & Run </a></li>
                      <li class="divider"></li>
                      <li><a href="#" onclick="run()"> Run Report </a></li>
                  </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span12 widget-box">
          <div class="widget-title">
            <a data-toggle="collapse" data-target="#report-container" href="#">
              {% if report.hide_criteria %}
                {{ report.title }}
                <small id="report_datetime" class="text-info pull-right">{% now "jS F Y H:i:s" %}</small><br>
              {% else %}
                Report
              {% endif %}
            </a>
          </div>
          <div class="collapse in" id="report-container">
            <div class="widget-content collapse in" id="report">
            </div> <!-- criteria -->
          </div> <!-- criteria -->
        </div> <!-- span12 -->
      </div> <!-- row-fluid -->
    </div>

{% endblock %}
