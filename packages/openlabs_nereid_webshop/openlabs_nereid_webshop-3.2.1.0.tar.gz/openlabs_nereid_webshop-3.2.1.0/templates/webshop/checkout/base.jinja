{% extends 'base.jinja' %}

{% from '_helpers.jinja' import render_address %}

{% macro checkout_breadcrumb(step) %}
    <!-- Checkout Step Indicator -->
    <div class="row checkout-steps">
      <ul class="list-inline center">
        <li>
          <a href="{{ url_for('nereid.checkout.sign_in') }}"
              class="{% if step == 1 %}active{% elif step > 1 %}done{% endif %}">
            <span><i class="fa fa-check"></i></span>
            <div class="text">{{ _('Sign In') }}</div>
          </a>
        </li>
        <li><span class="muted"></span>------------</li>
        <li>
          <a href="{{ url_for('nereid.checkout.shipping_address') }}"
              class="{% if step == 2 %}active{% elif step > 2 %}done{% else %}undone{% endif %}">
            <span>2</span>
            <div class="text">{{ _('Delivery') }}</div>
          </a>
        </li>
        <li><span class="muted"></span>------------</li>
        <li>
          <a  href="{{ url_for('nereid.checkout.payment_method') }}"
              class="{% if step == 3 %}active{% elif step > 3 %}done{% else %}undone{% endif %}">
            <span>3</span>
            <div class="text">{{ _('Payment') }}</div>
          </a>
        </li>
      </ul>
    </div>
{% endmacro %}


{% macro google_analytics_add_product() %}
  {# This must be called from within a script tag #}
  {% set cart = get_cart() %}

  // Set tracker currency to sale currency
  ga('set', '&cu', '{{ cart.sale.currency.code }}');

  {% for line in cart.sale.lines if line.product %}
    ga('ec:addProduct', {{ line.product.ga_product_data(price=line.unit_price, quantity=line.quantity|string)|tojson|safe }});
  {% endfor %}
{% endmacro %}

{% macro cart_summary() %}
{% set cart = get_cart() %}
<div class="col-md-4">
  <div class="row">
    <div class="col-md-12 col-sm-6 pad-nil panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">{{ _('Cart Summary') }}
          <span class="pull-right"><a href="{{ url_for('nereid.cart.view_cart') }}">
            <i class="fa fa-pencil"></i> {{ _('Edit') }}</a>
          </span>
        </h3>
      </div>
      <div class="panel-body">
        {% for line in cart.sale.lines %}
        <!-- Product Item 1 -->
        <div class="row border">
          <div class="col-xs-3">
            {% if line.product and line.product.default_image %}
            <img src="{{ CDN }}{{ line.product.default_image.transform_command().thumbnail(100, 100, 'a') }}" alt="{{ line.product.name }}" title="{{ line.product.name }}"/>
            {% endif %}
          </div>
          <div class="col-xs-6">
            <a href="{{ url_for('product.product.render', uri=line.product.uri) }}" class="product-name">{{ line.description }}</a><br>
            <strong class="text-muted">{{ _('Qty') }} :</strong> {{ line.quantity }}
          </div>
          <div class="col-xs-3">
            <span class="price">{{ line.amount|currencyformat(cart.sale.currency.code) }}</span>
          </div>
        </div>
        {% endfor %}

        <div class="row">
          <div class="col-xs-8">
            <strong class="pull-right total">{{ _('Cart Total') }}</strong>
          </div>
          <div class="col-xs-4">
            <span class="price total">
              <strong>{{ cart.sale.untaxed_amount|currencyformat(cart.sale.currency.code) }}</strong>
            </span>
          </div>
        </div>

        {% if cart.sale.tax_amount %}
        <div class="row">
          <div class="col-xs-8">
            <strong class="pull-right total">{{ _('Estimated Tax') }}</strong>
          </div>
          <div class="col-xs-4">
            <span class="price total">{{ cart.sale.tax_amount|currencyformat(cart.sale.currency.code) }}&nbsp;&nbsp;
              <span data-toggle="tooltip" data-placement="bottom" title="" data-original-title="The sales tax listed on the checkout page is only an estimate. The final total sales tax will be reflected on your invoice and will be included state and local sales taxes, as well as any applicable rebates or fees." class="estimated-tax">
                [<span class="text-info"><i class="fa fa-question"></i></span>]
              </span>
            </span>
          </div>
        </div>
        {% endif %}

        <hr>
        <div class="row">
          <div class="col-xs-8">
            <strong class="pull-right grand-total">{{ _('Total') }}</strong>
          </div>
          <div class="col-xs-4">
            <span class="price grand-total">{{ cart.sale.total_amount|currencyformat(cart.sale.currency.code) }}</span>
          </div>
        </div>
      </div>
    </div><!-- END: panel -->

    {% if cart.sale.shipment_address %}
    <div class="col-md-12 col-sm-6 pad-nil panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Shipping Address
          <span class="pull-right"><a href="{{ url_for('nereid.checkout.shipping_address') }}">
            <i class="fa fa-pencil"></i> {{ _('Edit') }}</a>
          </span>
        </h3>
      </div>
      <div class="panel-body">
        {{ render_address(cart.sale.shipment_address, edit=False) }}
      </div>
    </div>
    {% endif %}

    {% if cart.sale.invoice_address %}
    <div class="col-md-12 col-sm-6 pad-nil panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">{{ _('Billing Address') }}
          <span class="pull-right"><a href="{{ url_for('nereid.checkout.billing_address') }}">
            <i class="fa fa-pencil"></i> {{ _('Edit') }}</a>
          </span>
        </h3>
      </div>
      <div class="panel-body">
        {{ render_address(cart.sale.invoice_address, edit=False) }}
      </div>
    </div>
    {% endif %}

  </div>
</div>
{% endmacro %}
