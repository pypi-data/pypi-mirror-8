---
version: "2.0"

name: vm_job

actions:
  calc_summ:
    description: HTTP request to the server.
    base: std.http
    base-input:
      url: 'http://{$.vm_ip}:5000/summ'
      method: POST
      body:
        arguments: $.arguments
    output:
      summ_result: $.content.result

  wait_ssh:
    description: Simple SSH command.
    base: std.ssh
    base-input:
      host: $.host
      username: $.username
      password: $.password
      cmd: 'ls -l'

  run_calculator_server:
    description: SSH command to run the server.
    base: std.ssh
    base-input:
      host: $.host
      username: $.username
      password: $.password
      cmd: 'nohup python ~/web_app.py > web_app.log &'

workflows:
  run_vm_job:
    type: direct

    input:
      - server_name # Name of the new instance
      - image_id  # image id from Glance service
      - flavor_id # flavor id - type of instance hardware
      - ssh_username # VM username
      - ssh_password # VM password
      - admin_email # email address to send notifications to
      - from_email # email address to send notifications from
      - smtp_server # SMTP server to use for sending emails (e.g. smtp.gmail.com:587)
      - smtp_password # password to connect to SMTP server

    description: |
      This workflow spins up a vm,
      deploys calculator web app on it
      and runs the calculation by sending
      a request to calculator app.

    tasks:
      create_vm:
        description: Initial request to create a VM.
        action: nova.servers_create name={$.server_name} image={$.image_id} flavor={$.flavor_id}
        publish:
          vm_id: $.id
        on-success:
          - search_for_ip
        on-error:
          - send_create_vm_error

      search_for_ip:
        description: Gets first free ip from Nova floating IPs.
        action: nova.floating_ips_findall instance_id=null
        publish:
          vm_ip: $[0].ip
        on-success:
          - associate_ip
        on-error:
          - send_create_vm_error

      associate_ip:
        description: Associate server with one of floating IPs.
        action: nova.servers_add_floating_ip server={$.vm_id} address={$.vm_ip}
        policies:
          wait-after: 5
        on-success:
          - wait_ssh
        on-error:
          - send_create_vm_error

      wait_ssh:
        description: Wait till operating system on the VM is up (SSH command).
        action: wait_ssh username={$.ssh_username} password={$.ssh_password} host={$.vm_ip}
        policies:
          retry:
            count: 10
            delay: 10
        on-success:
          - run_server
        on-error:
          - send_create_vm_error

      run_server:
        description: When SSH is up, we are able to run the server on VM (SSH command).
        action: run_calculator_server host={$.vm_ip} username={$.ssh_username} password={$.ssh_password}
        on-success:
          - calc_summ
        on-error:
          - send_create_vm_error

      calc_summ:
        description: Send HTTP request on server and calc the result.
        action: calc_summ
        input:
          arguments:
            - 32
            - 45
            - 23
          vm_ip: $.vm_ip
        policies:
          retry:
            count: 10
            delay: 1
        publish:
          result: $.summ_result
        on-complete:
          - send_result_email

      send_result_email:
        description: In case of createVM error send e-mail with error message.
        action: std.email
        input:
          params:
            to: [$.admin_email]
            subject: Workflow result
            body: |
              Workflow result of execution {$.__execution.id} is {$.result}

              -- Thanks, Mistral Team.
          settings:
            smtp_server: $.smtp_server
            from: $.from_email
            password: $.smtp_password
        on-complete:
          - delete_vm

      send_create_vm_error:
        description: In case of createVM error send e-mail with error message.
        action: std.email
        input:
          params:
            to: [$.admin_email]
            subject: Workflow error
            body: |
              Failed to create a VM in execution {$.__execution.id}

              -- Thanks, Mistral Team.
          settings:
            smtp_server: $.smtp_server
            from: $.from_email
            password: $.smtp_password
        on-complete: 
          - delete_vm

      delete_vm:
        description: Destroy VM.
        action: nova.servers_delete server={$.vm_id}
