

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Overview &mdash; pyrana 0.6 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="pyrana 0.6 documentation" href="../index.html" />
    <link rel="up" title="Introduction" href="index.html" />
    <link rel="next" title="Pygame and Video" href="player_02.html" />
    <link rel="prev" title="Introduction" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="player_02.html" title="Pygame and Video"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Introduction"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">pyrana 0.6 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Introduction</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h1>
<p>Movie files have a few basic components. First, the file itself is
called a <em>container</em>, and the type of container determines where the
information in the file goes. Examples of containers are AVI, Quicktime,
Matroska (MKV) or ogg. Next, you have a bunch of <em>streams</em>; for example,
you usually have an audio stream and a video stream. (A &#8220;stream&#8221; is just
a fancy word for &#8220;a succession of data elements made available over
time&#8221;.) The data elements in a stream are called <em>frames</em>. Each stream
is encoded by a different kind of <strong>codec</strong>. The codec defines how the
actual data is COded and DECoded - hence the name CODEC. Examples of
codecs are WEBM, H.264, MP3 or Vorbis. <em>Packets</em> are then read from the
stream. Packets are pieces of data that can contain bits of data that
are decoded into raw frames that we can finally manipulate for our
application. For our purposes, each packet contains complete frames, or
multiple frames in the case of audio.</p>
<p>At its very basic level, dealing with video and audio streams is very
easy:</p>
<div class="highlight-python"><pre>with open_stream("video.ogg") as video:
    frame = video.read_packet()
if not frame.complete:
        continue
    do_something(frame)</pre>
</div>
<p>We will see soon enough that in real python code, thanks to pyrana, the
real code is not very different from this pseudo code above. However,
some programs might have a very complex <tt class="docutils literal"><span class="pre">do_something</span></tt> step. So in
this tutorial, we&#8217;re going to open a file, read from the video stream
inside it, and our <tt class="docutils literal"><span class="pre">do_something</span></tt> is going to be writing the frame to
a PPM file.</p>
</div>
<div class="section" id="opening-the-file">
<h1>Opening the File<a class="headerlink" href="#opening-the-file" title="Permalink to this headline">¶</a></h1>
<p>First, let&#8217;s see how we open a file in the first place. With pyrana, you
have to first initialize the library.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">pyrana</span>

<span class="c"># somewhere, once per run</span>

<span class="n">pyrana</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</pre></div>
</div>
<p>This registers all available file formats and codecs with the library so
they will be used automatically when a file with the corresponding
format/codec is opened. Note that you only need to call pyrana.setup()
once, but it is safe to do it multiple times, if you cannot avoid it.</p>
<p>Now we can actually open the media file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">dmx</span> <span class="o">=</span> <span class="n">pyrana</span><span class="o">.</span><span class="n">Demuxer</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
</pre></div>
</div>
<p>Here <tt class="docutils literal"><span class="pre">dmx</span></tt> is one of the most common shortcut names for <tt class="docutils literal"><span class="pre">demuxer</span></tt>.
We get our filename from the first argument. The Demuxer instance needs
a valid, already open, binary data provider to be used as underlying
source of data. Now you can access the stream informations using the
<tt class="docutils literal"><span class="pre">streams</span></tt> attribute. <tt class="docutils literal"><span class="pre">demuxer.streams</span></tt> is just a collections of data
structures, so let&#8217;s find the zero-th (aka the first) video stream in
the collection.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pyrana.formats</span> <span class="kn">import</span> <span class="n">find_stream</span><span class="p">,</span> <span class="n">MediaType</span>
<span class="c"># ...</span>
<span class="n">sid</span> <span class="o">=</span> <span class="n">find_stream</span><span class="p">(</span><span class="n">demuxer</span><span class="o">.</span><span class="n">streams</span><span class="p">,</span>
                  <span class="mi">0</span><span class="p">,</span>
                  <span class="n">MediaType</span><span class="o">.</span><span class="n">AVMEDIA_TYPE_VIDEO</span><span class="p">)</span>
<span class="c"># sid: Stream ID</span>
<span class="n">vstream</span> <span class="o">=</span> <span class="n">dmx</span><span class="o">.</span><span class="n">streams</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
</pre></div>
</div>
<p>Now we can have all the available metadata about the stream (e.g. width
and height for a video stream, channel count and bytes per sample for an
audio stream). However, we still need a decoder for that video stream.
Simple enough:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">vdec</span> <span class="o">=</span> <span class="n">dmx</span><span class="o">.</span><span class="n">open_decoder</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
</pre></div>
</div>
<p>Simple as that! now <tt class="docutils literal"><span class="pre">codec</span></tt> is ready to roll and decode the frames
that will be sent to it.</p>
</div>
<div class="section" id="reading-the-data">
<h1>Reading the Data<a class="headerlink" href="#reading-the-data" title="Permalink to this headline">¶</a></h1>
<p>What we&#8217;re going to do is read through the entire video stream by
reading in the packet, decoding it into our frame, and once our frame is
complete, we will convert and save it.</p>
<p>Since we&#8217;re planning to output PPM files, which are stored in 24-bit
RGB, we&#8217;re going to have to convert our frame from its native format to
RGB. pyrana will do these conversions for us. For most projects
(including ours) we&#8217;re going to want to convert our initial frame to a
specific format. It&#8217;s enough to ask an Image from a (video) Frame using
the image() method and specifying the desired pixel format. The default
value for image() is the same as the video stream.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
   <span class="n">dmx</span> <span class="o">=</span> <span class="n">pyrana</span><span class="o">.</span><span class="n">formats</span><span class="o">.</span><span class="n">Demuxer</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
   <span class="n">sid</span> <span class="o">=</span> <span class="n">pyrana</span><span class="o">.</span><span class="n">formats</span><span class="o">.</span><span class="n">find_stream</span><span class="p">(</span><span class="n">dmx</span><span class="o">.</span><span class="n">streams</span><span class="p">,</span>
                                    <span class="mi">0</span><span class="p">,</span>
                                    <span class="n">MediaType</span><span class="o">.</span><span class="n">AVMEDIA_TYPE_VIDEO</span><span class="p">)</span>
   <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="n">vdec</span> <span class="o">=</span> <span class="n">dmx</span><span class="o">.</span><span class="n">open_decoder</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
   <span class="n">frame</span> <span class="o">=</span> <span class="n">vdec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">dmx</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">sid</span><span class="p">))</span>
   <span class="n">image</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">pyrana</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">PixelFormat</span><span class="o">.</span><span class="n">AV_PIX_FMT_RGB24</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="a-note-on-packets">
<h1>A note on packets<a class="headerlink" href="#a-note-on-packets" title="Permalink to this headline">¶</a></h1>
<p>Technically a packet can contain partial frames or other bits of data,
but pyrana&#8217;s Demuxers (thanks to the ffmpeg libraries) ensures that the
packets we get contain either complete or multiple frames.</p>
<p>The process, again, is simple: Demuxer.read_frame() reads in a packet
and stores it in a Packet object. Decoder.decode() converts the packet
to a frame for us. However, we might not have all the information we
need for a frame after decoding a packet, so Decoder.decode() raises
NeedFeedError if it is not able to decode the next frame. Finally, we
use Image.convert() to convert from the native format
(Image.pixel_format) to RGB.</p>
<p>Now all we need to do is make the save_frame function to write the RGB
information to a file in PPM format. We&#8217;re going to be kind of sketchy
on the PPM format itself; trust us, it works.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">ppm_write</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">seqno</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    saves a raw frame in a PPM image. See man ppm for details.</span>
<span class="sd">    the `seqno` parameter is just to avoid to overwrite them without</span>
<span class="sd">    getting too fancy with the filename generation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">pyrana</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">PixelFormat</span><span class="o">.</span><span class="n">AV_PIX_FMT_RGB24</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;frame</span><span class="si">%d</span><span class="s">.ppm&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">seqno</span><span class="p">),</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="s">&quot;P6</span><span class="se">\n</span><span class="si">%i</span><span class="s"> </span><span class="si">%i</span><span class="se">\n</span><span class="s">255</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
</pre></div>
</div>
<p>In this case we require the full frame (not just the image) to be passed
to be sure to get an image with the conformant Pixel Format. We do a bit
of standard file opening, etc., and then write the RGB data. We write
the file one line at a time. A PPM file is simply a file that has RGB
information laid out in a long string. If you know HTML colors, it would
be like laying out the color of each pixel end to end like
#ff0000#ff0000.... would be a red screen. (It&#8217;s stored in binary and
without the separator, but you get the idea.) The header indicated how
wide and tall the image is, and the max size of the RGB values.</p>
<p>Most image programs should be able to open PPM files. Test it on some
movie files.</p>
<p>The full working code used in this post is <a class="reference external" href="https://github.com/mojaves/pyrana/blob/master/examples/03_decode_video.py">available
here</a>.</p>
<script src="https://gist.github.com/mojaves/6949801.js"></script></div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Overview</a></li>
<li><a class="reference internal" href="#opening-the-file">Opening the File</a></li>
<li><a class="reference internal" href="#reading-the-data">Reading the Data</a></li>
<li><a class="reference internal" href="#a-note-on-packets">A note on packets</a></li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Introduction</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="player_02.html"
                        title="next chapter">Pygame and Video</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/tutorial/player_01.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="player_02.html" title="Pygame and Video"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Introduction"
             >previous</a> |</li>
        <li><a href="../index.html">pyrana 0.6 documentation</a> &raquo;</li>
          <li><a href="index.html" >Introduction</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Francesco Romani.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>