<metal:map define-macro="map">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:i18n="http://xml.zope.org/namespaces/i18n"
  metal:use-macro="context/main_template/macros/master"
  i18n:domain="eea">

<body>
  <metal:content-core fill-slot="content-core">
    <metal:block define-macro="content-core">
      <div metal:use-macro="context/map_macros/macros/geotags_map" />

      <div tal:define="
        contentFilter contentFilter|request/contentFilter|nothing;
        contentFilter python:contentFilter and dict(contentFilter) or {};
        isAnon context/@@plone_portal_state/anonymous;
        b_size b_size|request/b_size|nothing;
        b_size python:b_size and int(b_size) or None;
        contentFilter python: { 'review_state' : 'published' } if isAnon else contentFilter;
        is_a_topic python:context.portal_type in ['Topic', 'Collection'];
        folderContents folderContents|nothing; folderContents python:folderContents or is_a_topic and context.queryCatalog(batch=True, b_size=b_size or 100,  **contentFilter) or context.getFolderContents(contentFilter, batch=True, b_size=b_size or 100);
        Batch python:modules['Products.CMFPlone'].Batch;
        b_start python:request.get('b_start', 0);
        batch python:isinstance(folderContents, Batch) and folderContents or Batch(folderContents, b_size or 100, int(b_start), orphan=1);
        self nocall:context/@@faceted-map-view;
        res python:self.map_points(batch);
        portal_url context/@@plone_portal_state/portal_url;
        ">
        <div id="map_points" tal:content="python:res if res != [] else 'None'"
             class="visualHidden" />
        <div id="portal_url" tal:content="portal_url" class="visualHidden" />

        <div tal:attributes="data-modal string:False">
            <tal:folder_listing tal:condition="is_a_topic">
                <metal:folder_listing metal:use-macro="context/atct_topic_view/macros/content-core" />
            </tal:folder_listing>
            <tal:folder_listing tal:condition="not:is_a_topic">
                <metal:folder_listing metal:use-macro="context/folder_listing/macros/content-core" />
            </tal:folder_listing>
        </div>

      </div>
    </metal:block>
  </metal:content-core>
</body>
</html>
</metal:map>
